<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badugi Gym (Trainer v16)</title>
    <style>
        /* --- Base & Layout --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #2c3e50; 
            color: #ecf0f1; 
            text-align: center; 
            padding: 10px; 
            margin: 0;
            -webkit-text-size-adjust: 100%;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background-color: #34495e; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
        }

        /* --- Header Info --- */
        .info-panel { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            font-weight: bold; 
            font-size: 0.95em;
            color: #bdc3c7;
        }

        /* --- Situation Banner --- */
        .situation { 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            font-weight: bold; 
            font-size: 1.1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .sit-clean { background: #27ae60; color: white; }
        .sit-raise { background: #e74c3c; color: white; } 
        .sit-sbraise { background: #c0392b; color: white; border: 2px solid #f1c40f; } 
        .sit-limp { background: #f39c12; color: white; }
        .sit-finish { background: #95a5a6; color: white; }

        /* --- Cards (Mobile Optimized) --- */
        .cards { 
            display: flex; 
            justify-content: center; 
            gap: 2%; 
            margin: 20px 0; 
            width: 100%;
        }
        .card { 
            width: 22%; max-width: 80px; aspect-ratio: 2/3;
            background: white; border-radius: 6px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-weight: bold; border: 2px solid #bdc3c7;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: clamp(18px, 6vw, 32px);
        }
        .suit-s { color: #2c3e50; } .suit-h { color: #c0392b; } 
        .suit-d { color: #2980b9; } .suit-c { color: #27ae60; } 

        /* --- Buttons --- */
        .buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        button { 
            padding: 0; height: 55px; font-size: 16px; border: none; border-radius: 8px; 
            cursor: pointer; color: white; font-weight: bold; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.1s;
        }
        button:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; opacity: 0.5; box-shadow: none; transform: translateY(2px); }
        .btn-fold { background-color: #7f8c8d; } .btn-call { background-color: #f39c12; } .btn-raise { background-color: #e74c3c; }

        /* --- Log Area --- */
        .log-area { text-align: left; }
        textarea { 
            width: 100%; height: 80px; background: #ecf0f1; color: #2c3e50; 
            border: none; padding: 10px; border-radius: 6px; 
            font-family: monospace; font-size: 11px; box-sizing: border-box; resize: none;
        }
        .copy-btn { background-color: #3498db; width: 100%; height: 45px; margin-top: 8px; }
        .gpts-link { 
            display: block; background-color: #10a37f; color: white; text-decoration: none; 
            padding: 15px; border-radius: 8px; margin-top: 12px; font-weight: bold; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="info-panel">
        <div id="positionDisplay">Pos: BTN</div>
        <div>Played: <span id="handCount">0</span> / 50</div>
    </div>
    <div id="situationDisplay" class="situation sit-clean">Situation...</div>
    <div class="cards" id="cardContainer"></div>
    <div class="buttons">
        <button id="btnFold" class="btn-fold" onclick="recordAction('Fold')">Fold</button>
        <button id="btnCall" class="btn-call" onclick="recordAction('Call')">Call</button>
        <button id="btnRaise" class="btn-raise" onclick="recordAction('Raise')">Raise</button>
    </div>
    <div class="log-area">
        <textarea id="logOutput" readonly placeholder="プレイログがここに表示されます"></textarea>
        <button class="copy-btn" onclick="copyLogOnly()">ログをコピー</button>
        <!-- GPTsのURLはご自身のものに差し替えてください -->
        <a href="https://chatgpt.com/g/g-69326860583c8191ad74fb34d1669004-hatouki-zhan-lue-koti" target="_blank" class="gpts-link">コーチ (GPTs) を呼ぶ ↗</a>
    </div>
</div>
<script>
    const MAX_HANDS = 50;
    const suits = [{ui:'♠',css:'suit-s',log:'s'},{ui:'♥',css:'suit-h',log:'h'},{ui:'♦',css:'suit-d',log:'d'},{ui:'♣',css:'suit-c',log:'c'}];
    const ranks = ['A','2','3','4','5','6','7','8','9','T','J','Q','K'];
    const RANK_MAP = {'A':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, 'T':10, 'J':11, 'Q':12, 'K':13};
    const INV_RANK_MAP = {1:'A', 2:'2', 3:'3', 4:'4', 5:'5', 6:'6', 7:'7', 8:'8', 9:'9', 10:'T', 11:'J', 12:'Q', 13:'K'};
    const posOrder = ['UTG','MP','CO','BTN','SB','BB'];
    let currentHand=[], currentPos="", raiserPos="", situationText="", situationType="", historyLog=[], handCount=0;

    function getCombinations(array, k) {
        const result = [];
        function p(t, i) {
            if (t.length === k) { result.push(t); return; }
            if (i + 1 > array.length) return;
            p(t.concat([array[i]]), i + 1);
            p(t, i + 1);
        }
        p([], 0);
        return result;
    }

    function evaluateHand(handArray) {
        const parsed = handArray.map(c => ({
            rankVal: RANK_MAP[c.rank],
            suitLog: c.suit.log,
            raw: c.rank + c.suit.log
        }));
        
        for (let size = 4; size >= 1; size--) {
            const combos = getCombinations(parsed, size);
            const validCombos = [];
            for (const combo of combos) {
                const rVals = combo.map(c => c.rankVal);
                const sVals = combo.map(c => c.suitLog);
                if (new Set(rVals).size === size && new Set(sVals).size === size) {
                    const maxVal = Math.max(...rVals);
                    validCombos.push({ combo: combo, max: maxVal });
                }
            }
            if (validCombos.length > 0) {
                validCombos.sort((a, b) => a.max - b.max);
                const best = validCombos[0];
                let labelType = size === 4 ? "Badugi" : size === 3 ? "Tri" : size === 2 ? "2-card" : "1-card";
                const highCard = INV_RANK_MAP[best.max];
                const sortedCombo = best.combo.sort((a,b) => a.rankVal - b.rankVal);
                
                // --- AI Hint Logic (Tag Generation) ---
                let note = "";
                
                // 1. Badugi (4-card): Check InnerTri Strength
                if (size === 4) {
                    // 2nd strongest card is the max of the inner tri (e.g. K-3-2-A -> 3 is max of A-2-3)
                    const innerMax = sortedCombo[2].rankVal; 
                    note = `InnerTri=${innerMax}`;
                }
                
                // 2. 2-card: Check Premium(A-2/A-3) vs Strong(A-4) vs Normal
                else if (size === 2) {
                    const v1 = sortedCombo[0].rankVal; // smallest
                    const v2 = sortedCombo[1].rankVal; // largest
                    if (v1 === 1) { // Contains Ace
                        if (v2 === 2 || v2 === 3) {
                            note = "Premium2"; // A-2, A-3
                        } else if (v2 === 4) {
                            note = "Strong2";  // A-4
                        } else {
                            note = "Normal2";
                        }
                    } else {
                        note = "Normal2";
                    }
                }

                return { 
                    label: `${highCard}-High ${labelType}`, 
                    best: sortedCombo.map(c => c.raw).join(' '),
                    note: note 
                };
            }
        }
        return { label: "Empty", best: "", note: "" };
    }

    function dealHand() {
        let deck = [];
        for(let s of suits) for(let r of ranks) deck.push({suit: s, rank: r});
        currentHand = [];
        for(let i=0; i<4; i++) {
            const idx = Math.floor(Math.random()*deck.length);
            currentHand.push(deck[idx]); deck.splice(idx,1);
        }
        currentPos = posOrder[Math.floor(Math.random()*posOrder.length)];
        
        if (currentPos === 'UTG') { situationType='clean'; situationText="Unopened"; }
        else if (currentPos === 'BB') {
            const r = Math.random();
            if (r < 0.33) { 
                const pr = ['UTG','MP','CO','BTN']; raiserPos=pr[Math.floor(Math.random()*pr.length)];
                situationType='raise'; situationText=`Facing ${raiserPos} Open`; 
            } else if (r < 0.66) { raiserPos='SB'; situationType='sb_raise'; situationText="Facing SB Open"; }
            else { situationType='limp'; situationText="SB Limped"; }
        } else {
            if (Math.random()<0.4) {
                const myIdx = posOrder.indexOf(currentPos);
                const prev = posOrder.slice(0, myIdx);
                raiserPos = prev[Math.floor(Math.random()*prev.length)];
                situationType='raise'; situationText=`Facing ${raiserPos} Open`;
            } else { situationType='clean'; situationText="Unopened"; }
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById('positionDisplay').textContent = `Pos: ${currentPos}`;
        document.getElementById('handCount').textContent = `${handCount} / ${MAX_HANDS}`;
        const sitDiv = document.getElementById('situationDisplay');
        const btnCall = document.getElementById('btnCall');
        if (situationType === 'raise' || situationType === 'sb_raise') {
            sitDiv.textContent = `${situationText}`; sitDiv.className = situationType==='sb_raise'?'situation sit-sbraise':'situation sit-raise';
            btnCall.textContent = "Call";
        } else if (situationType === 'limp') {
            sitDiv.textContent = "SB Limped"; sitDiv.className = 'situation sit-limp';
            btnCall.textContent = "Check";
        } else {
            sitDiv.textContent = "Unopened"; sitDiv.className = 'situation sit-clean';
            btnCall.textContent = "Call";
        }
        const container = document.getElementById('cardContainer');
        container.innerHTML = '';
        currentHand.forEach(c => {
            const div = document.createElement('div');
            div.className = `card ${c.suit.css}`;
            div.textContent = `${c.suit.ui}${c.rank}`;
            container.appendChild(div);
        });
    }
    function toggleButtons(enabled) {
        document.getElementById('btnFold').disabled = !enabled;
        document.getElementById('btnCall').disabled = !enabled;
        document.getElementById('btnRaise').disabled = !enabled;
    }
    function recordAction(action) {
        handCount++;
        let loggedAction = action;
        if (action === "Call" && situationType === 'limp') loggedAction = "Check";
        const handStr = currentHand.map(c => c.rank + c.suit.log).join(' ');
        const evalResult = evaluateHand(currentHand);
        
        let logLine = `ID:${handCount} | POS:${currentPos} | SIT:${situationText} | HAND:${handStr} | ACT:${loggedAction} | LABEL:${evalResult.label} | BEST:${evalResult.best}`;
        if (evalResult.note) {
            logLine += ` | NOTE:${evalResult.note}`;
        }
        historyLog.push(logLine);
        
        let outputText = historyLog.join('\n');
        if (handCount >= MAX_HANDS) {
            outputText += `\n\n__SUMMARY__|TOTAL:${handCount}`;
            document.getElementById('logOutput').value = outputText;
            document.getElementById('handCount').textContent = `${handCount} / ${MAX_HANDS}`;
            toggleButtons(false);
            const sitDiv = document.getElementById('situationDisplay');
            sitDiv.textContent = "SESSION FINISHED"; sitDiv.className = "situation sit-finish";
            const logArea = document.getElementById('logOutput'); logArea.scrollTop = logArea.scrollHeight;
            alert("50ハンド終了！\n「ログをコピー」してGPTsへ送信してください。");
            return;
        }
        document.getElementById('logOutput').value = outputText;
        const logArea = document.getElementById('logOutput'); logArea.scrollTop = logArea.scrollHeight;
        dealHand();
    }
    function copyLogOnly() {
        const txt = document.getElementById("logOutput");
        txt.select(); txt.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(txt.value).then(() => { alert("ログをコピーしました！"); });
    }
    dealHand();
</script>
</body>
</html>